<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propuesta San Valent√≠n - Part√≠culas IA</title>

    <!-- Librer√≠as MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background: #050505;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }

        #canvas1 {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #input_video {
            display: none;
        }

        .camera-preview {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 160px;
            height: 120px;
            border-radius: 10px;
            border: 2px solid rgba(255, 60, 100, 0.5);
            overflow: hidden;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            text-align: center;
            pointer-events: none;
            mix-blend-mode: overlay;
            width: 100%;
            transition: opacity 0.5s;
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 300;
            text-transform: uppercase;
            text-shadow: 0 0 20px rgba(255, 60, 100, 0.5);
            color: #fff0f5;
            transition: opacity 0.5s ease;
        }

        .fade-out {
            opacity: 0;
        }

        p {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        .status-msg {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #ff69b4;
            font-weight: bold;
            min-height: 20px;
        }

        /* --- Instrucciones Fijas Inferiores --- */
        .instruction-bar {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            text-align: center;
            z-index: 20;
            pointer-events: none;
        }

        .instruction-text {
            display: inline-block;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 25px;
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 1.1rem;
            letter-spacing: 1px;
            backdrop-filter: blur(4px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .instruction-text span {
            color: #ff69b4;
            font-weight: bold;
        }

        .btn-cam {
            pointer-events: auto;
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 60, 100, 0.5);
            color: white;
            border-radius: 30px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: 0.3s;
            text-transform: uppercase;
            font-size: 0.9rem;
            margin-top: 20px;
            display: none;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .instruction-text {
                font-size: 0.9rem;
                padding: 8px 15px;
                width: 90%;
            }

            .camera-preview {
                width: 100px;
                height: 75px;
                bottom: 90px;
            }
        }
    </style>
</head>

<body>

    <canvas id="canvas1"></canvas>

    <div class="camera-preview" id="cameraPreview">
        <video id="input_video"></video>
    </div>

    <!-- Barra de Instrucciones Fija -->
    <div class="instruction-bar">
        <div class="instruction-text" id="instructionText">
            Acerca tu mano para <span>despertar el coraz√≥n</span>
        </div>
    </div>

    <div class="content" id="uiContent">
        <p>Experiencia Interactiva</p>
        <h1 id="mainTitle">Bienvenido</h1>
        <p class="status-msg" id="statusMsg">Solicitando acceso a la c√°mara...</p>
        <button class="btn-cam" id="btnRetry" onclick="startCamera()">Intentar de nuevo</button>
    </div>

    <script>
        const canvas = document.getElementById('canvas1');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let particlesArray = [];
        let heartSizeScale = Math.min(canvas.width, canvas.height) / 400;

        // Estados
        let isHandsDetected = false;
        let isHandOpen = false; // Pregunta
        let isThumbsUp = false; // Respuesta
        let isFingerHeart = false; // EASTER EGG (BTS)

        let angleY = 0;
        const perspective = 800;
        const mouse = { x: null, y: null, radius: 150 };

        window.addEventListener('mousemove', (e) => { mouse.x = e.x; mouse.y = e.y; });
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            heartSizeScale = Math.min(canvas.width, canvas.height) / 400;
            initSystem();
        });

        // --- 1. Generar Puntos del Coraz√≥n ---
        function calculateHeartTargets(count) {
            let points = [];
            for (let i = 0; i < count; i++) {
                let t = Math.random() * Math.PI * 2;
                let x = 16 * Math.pow(Math.sin(t), 3);
                let y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));

                let r = Math.sqrt(Math.random());
                let tx = x * r * 15 * heartSizeScale;
                let ty = y * r * 15 * heartSizeScale;
                let thickness = 10 * heartSizeScale * (1 - r * 0.5);
                let tz = (Math.random() - 0.5) * thickness * 30;

                points.push({ x: tx, y: ty, z: tz });
            }
            return points;
        }

        // --- 2. Generar Puntos de Texto ---
        function calculateTextTargets(textContent) {
            let points = [];
            if (canvas.width <= 0 || canvas.height <= 0) return points;

            const fontSize = Math.min(canvas.width * 0.12, 100);
            ctx.font = `900 ${fontSize}px Verdana`;
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const lines = textContent.split('\n');
            const lineHeight = fontSize * 1.1;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let startY = canvas.height * 0.4;

            lines.forEach((line, i) => {
                ctx.fillText(line, canvas.width / 2, startY + (i * lineHeight));
            });

            const gap = 4;
            try {
                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imgData.data;
                for (let y = 0; y < canvas.height; y += gap) {
                    for (let x = 0; x < canvas.width; x += gap) {
                        if (data[(y * canvas.width + x) * 4 + 3] > 128) {
                            points.push({
                                x: x - canvas.width / 2,
                                y: y - canvas.height / 2,
                                z: 0
                            });
                        }
                    }
                }
            } catch (e) { return points; }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            return points;
        }

        // --- Clase Part√≠cula ---
        class Particle {
            constructor(heartTarget, questionTarget, answerTarget, btsTarget) {
                // Objetivo Coraz√≥n
                this.hx = heartTarget ? heartTarget.x : (Math.random() - 0.5) * canvas.width;
                this.hy = heartTarget ? heartTarget.y : (Math.random() - 0.5) * canvas.height;
                this.hz = heartTarget ? heartTarget.z : (Math.random() - 0.5) * 500;

                // Objetivo Pregunta
                this.qx = questionTarget ? questionTarget.x : this.hx;
                this.qy = questionTarget ? questionTarget.y : this.hy;
                this.qz = questionTarget ? questionTarget.z : this.hz;
                this.hasQTarget = !!questionTarget;

                // Objetivo Respuesta
                this.ax = answerTarget ? answerTarget.x : this.hx;
                this.ay = answerTarget ? answerTarget.y : this.hy;
                this.az = answerTarget ? answerTarget.z : this.hz;
                this.hasATarget = !!answerTarget;

                // Objetivo BTS (Easter Egg)
                this.bx = btsTarget ? btsTarget.x : this.hx;
                this.by = btsTarget ? btsTarget.y : this.hy;
                this.bz = btsTarget ? btsTarget.z : this.hz;
                this.hasBTarget = !!btsTarget;

                // Posici√≥n Dispersa Base
                this.dx = (Math.random() - 0.5) * canvas.width * 1.5;
                this.dy = (Math.random() - 0.5) * canvas.height * 1.5;
                this.dz = (Math.random() - 0.5) * 1000;

                // Iniciar en posici√≥n dispersa
                this.x = this.dx;
                this.y = this.dy;
                this.z = this.dz;

                // --- CAMBIO: AUMENTO DE TAMA√ëO ---
                // Original: Math.random() * 2 + 0.5;
                // Nuevo: Math.random() * 3 + 1.5; (M√≠nimo 1.5px, M√°ximo 4.5px)
                this.sizeBase = Math.random() * 3 + 1.5;

                this.colorHue = Math.random() * 40 + 330;
                this.saturation = '80%';
                this.lightness = '60%';
            }

            draw(scale, screenX, screenY) {
                let alpha = scale * 0.8;
                let l = this.lightness;
                let s = this.saturation;
                let h = this.colorHue;

                if (isFingerHeart && this.hasBTarget) {
                    // BTS Mode: P√∫rpura brillante
                    h = 270; s = '100%'; l = '65%';
                } else if (isThumbsUp && this.hasATarget) {
                    h = 350; s = '100%'; l = '70%';
                } else if (isHandOpen && this.hasQTarget) {
                    l = '90%'; s = '20%';
                }

                ctx.fillStyle = `hsla(${h}, ${s}, ${l}, ${alpha})`;
                ctx.beginPath();
                ctx.arc(screenX, screenY, this.sizeBase * scale, 0, Math.PI * 2);
                ctx.fill();
            }

            update() {
                let tx, ty, tz;

                if (!isHandsDetected) {
                    tx = this.dx; ty = this.dy; tz = this.dz;
                } else if (isFingerHeart) {
                    // MODO BTS
                    if (this.hasBTarget) {
                        tx = this.bx; ty = this.by; tz = this.bz;
                    } else {
                        tx = this.hx * 2; ty = this.hy * 2; tz = this.hz;
                    }
                } else if (isThumbsUp) {
                    // MODO RESPUESTA
                    if (this.hasATarget) {
                        tx = this.ax; ty = this.ay; tz = this.az;
                    } else {
                        tx = this.hx * 2; ty = this.hy * 2; tz = this.hz;
                    }
                } else if (isHandOpen) {
                    // MODO PREGUNTA
                    if (this.hasQTarget) {
                        tx = this.qx; ty = this.qy; tz = this.qz;
                    } else {
                        tx = this.hx * 2; ty = this.hy * 2; tz = this.hz;
                    }
                } else {
                    // NEUTRO
                    tx = this.hx; ty = this.hy; tz = this.hz;
                }

                this.x += (tx - this.x) * 0.08;
                this.y += (ty - this.y) * 0.08;
                this.z += (tz - this.z) * 0.08;

                this.x += (Math.random() - 0.5) * 0.5;
                this.y += (Math.random() - 0.5) * 0.5;

                let cos = Math.cos(angleY);
                let sin = Math.sin(angleY);
                let rx = this.x * cos - this.z * sin;
                let rz = this.x * sin + this.z * cos;

                let scale = perspective / (perspective + rz + 1000);
                let screenX = rx * scale + canvas.width / 2;
                let screenY = this.y * scale + canvas.height / 2;

                this.draw(scale, screenX, screenY);
            }
        }

        function initSystem() {
            particlesArray = [];

            let questionPoints = calculateTextTargets("¬øQUIERES SER\nMI SAN VALENT√çN?");
            let answerPoints = calculateTextTargets("TE AMO\n‚ù§");
            let btsPoints = calculateTextTargets("I PURPLE YOU\nüíú"); // Easter Egg Text

            let maxCount = Math.max(questionPoints.length, answerPoints.length, btsPoints.length, 2500);
            let heartPoints = calculateHeartTargets(maxCount);

            for (let i = 0; i < maxCount; i++) {
                let hT = heartPoints[i];
                let qT = questionPoints[i] || null;
                let aT = answerPoints[i] || null;
                let bT = btsPoints[i] || null;
                particlesArray.push(new Particle(hT, qT, aT, bT));
            }
        }

        function animate() {
            ctx.fillStyle = 'rgba(5, 5, 5, 0.25)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            particlesArray.sort((a, b) => b.z - a.z);
            particlesArray.forEach(p => p.update());
            requestAnimationFrame(animate);
        }

        // --- MEDIA PIPE ---
        const videoElement = document.getElementById('input_video');
        const statusMsg = document.getElementById('statusMsg');
        const mainTitle = document.getElementById('mainTitle');
        const instructionText = document.getElementById('instructionText');
        const btnRetry = document.getElementById('btnRetry');
        let camera;

        function onResults(results) {
            let handsDetected = false;
            let handOpenDetected = false;
            let thumbsUpDetected = false;
            let fingerHeartDetected = false;

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                handsDetected = true;

                for (const landmarks of results.multiHandLandmarks) {
                    const thumbTip = landmarks[4];
                    const indexTip = landmarks[8];
                    const middleTip = landmarks[12];
                    const ringTip = landmarks[16];
                    const pinkyTip = landmarks[20];

                    const thumbIP = landmarks[3];
                    const indexPIP = landmarks[6];
                    const middlePIP = landmarks[10];
                    const ringPIP = landmarks[14];
                    const pinkyPIP = landmarks[18];
                    const indexMCP = landmarks[5];

                    const isIndexExt = indexTip.y < indexPIP.y;
                    const isMiddleExt = middleTip.y < middlePIP.y;
                    const isRingExt = ringTip.y < ringPIP.y;
                    const isPinkyExt = pinkyTip.y < pinkyPIP.y;

                    if (isIndexExt && isMiddleExt && isRingExt && isPinkyExt) {
                        handOpenDetected = true;
                    }

                    const isThumbUp = thumbTip.y < thumbIP.y;
                    const areOthersCurled = !isIndexExt && !isMiddleExt && !isRingExt && !isPinkyExt;

                    if (isThumbUp && areOthersCurled) {
                        thumbsUpDetected = true;
                    }

                    const dThumbIndex = Math.hypot(thumbTip.x - indexTip.x, thumbTip.y - indexTip.y);
                    const isIndexHigh = indexTip.y < indexMCP.y;

                    if (dThumbIndex < 0.06 && isIndexHigh) {
                        fingerHeartDetected = true;
                    }
                }
            }

            // Actualizar estado global
            isHandsDetected = handsDetected;

            // UI Logica - PRIORIDADES
            if (!isHandsDetected) {
                isHandOpen = false; isThumbsUp = false; isFingerHeart = false;
                mainTitle.classList.remove('fade-out');
                mainTitle.innerText = "Bienvenido";
                statusMsg.innerText = "Acerca tu mano para comenzar la magia...";
                statusMsg.style.color = "#ff69b4";
                instructionText.innerHTML = "Extiende tu mano y <span>crea amor</span>";
                return;
            }

            // GESTOS
            if (fingerHeartDetected) {
                if (!isFingerHeart) {
                    isFingerHeart = true;
                    isHandOpen = false; isThumbsUp = false;
                    mainTitle.classList.add('fade-out');
                    statusMsg.innerText = "¬°Nuestro secreto especial! üíú";
                    statusMsg.style.color = "#9b59b6";
                    instructionText.innerHTML = "‚ú® I Purple You ‚ú® <span>Mi amor eterno</span>";
                }
            } else if (thumbsUpDetected) {
                if (!isThumbsUp) {
                    isThumbsUp = true;
                    isHandOpen = false; isFingerHeart = false;
                    mainTitle.classList.add('fade-out');
                    statusMsg.innerText = "¬°El 'S√≠' m√°s hermoso! ‚ù§Ô∏è";
                    statusMsg.style.color = "#ff3366";
                    instructionText.innerHTML = "Juntos para siempre <span>‚ù§Ô∏è</span>";
                }
            } else if (handOpenDetected) {
                if (!isHandOpen) {
                    isHandOpen = true;
                    isThumbsUp = false; isFingerHeart = false;
                    mainTitle.classList.add('fade-out');
                    statusMsg.innerText = "Dime que s√≠...";
                    statusMsg.style.color = "#ffffff";
                    instructionText.innerHTML = "Si tu respuesta es S√≠: <span>Haz üëç</span>";
                }
            } else {
                if (isHandOpen || isThumbsUp || isFingerHeart || mainTitle.innerText === "Bienvenido") {
                    isHandOpen = false; isThumbsUp = false; isFingerHeart = false;
                    mainTitle.classList.add('fade-out');
                    statusMsg.innerText = "Tu presencia forma mi coraz√≥n.";
                    statusMsg.style.color = "#ff69b4";
                    instructionText.innerHTML = "Para declararme: <span>Abre tu mano ‚úã</span>";
                }
            }
        }

        async function startCamera() {
            btnRetry.style.display = 'none';
            const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
            hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
            hands.onResults(onResults);
            camera = new Camera(videoElement, {
                onFrame: async () => { await hands.send({ image: videoElement }); },
                width: 640, height: 480
            });
            try {
                await camera.start();
                statusMsg.innerText = "C√°mara activa. Pon tu mano.";
                instructionText.innerHTML = "Extiende tu mano y <span>crea amor</span>";
                document.getElementById('cameraPreview').style.opacity = 1;
            } catch (error) {
                console.error(error);
                statusMsg.innerText = "Necesitas dar permiso a la c√°mara.";
                instructionText.innerHTML = "Error: <span>Activa la c√°mara</span>";
                btnRetry.style.display = 'block';
            }
        }

        initSystem();
        animate();
        window.onload = startCamera;

    </script>
</body>

</html>